---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Import settings from Tina
import settings from '../../content/settings/global.json';

interface Props {
  title?: string;
  description?: string;
  image?: string;
}

const { title, description, image } = Astro.props;

// Build full title with suffix from settings
const fullTitle = title
  ? `${title}${settings.seo?.titleSuffix || ''}`
  : settings.companyName;

const metaDescription = description || settings.seo?.defaultDescription || '';

// Canonical URL
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// OG Image - default to logo or a placeholder
const ogImage = image || '/uploads/image.png';
const ogImageURL = new URL(ogImage, Astro.site);

// Get brand colors from settings
const primaryColor = settings.colors?.primary || '#2563eb';
const secondaryColor = settings.colors?.secondary || '#1e40af';
const accentColor = settings.colors?.accent || '#3b82f6';

// Schema.org JSON-LD
const schemaOrg = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": settings.companyName,
  "description": metaDescription,
  "url": Astro.site?.toString(),
  "logo": ogImageURL.toString(),
  "image": ogImageURL.toString(),
  "telephone": settings.contact?.phone,
  "email": settings.contact?.email,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": settings.contact?.address,
    "addressLocality": "Bastiglia",
    "addressRegion": "MO",
    "postalCode": "41033",
    "addressCountry": "IT"
  },
  "sameAs": [
    settings.social?.facebook,
    settings.social?.instagram
  ].filter(Boolean),
  "priceRange": "€€"
};
---

<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={metaDescription} />
    <meta name="generator" content={Astro.generator} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph -->
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="it_IT" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:site_name" content={settings.companyName} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageURL} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Schema.org JSON-LD -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(schemaOrg)} />

    <title>{fullTitle}</title>

    <!-- Inject brand colors as CSS variables -->
    <style define:vars={{ primaryColor, secondaryColor, accentColor }}>
      :root {
        --color-primary: var(--primaryColor);
        --color-secondary: var(--secondaryColor);
        --color-accent: var(--accentColor);
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link">Vai al contenuto principale</a>

    <!-- Cursor glow effect -->
    <div id="cursor-glow" class="cursor-glow" aria-hidden="true"></div>

    <Header />
    <main id="main-content" class="flex-grow">
      <slot />
    </main>
    <Footer />

    <!-- Cursor glow & animations script -->
    <script>
      // Cursor glow effect
      const cursorGlow = document.getElementById('cursor-glow');
      let mouseX = 0, mouseY = 0;
      let glowX = 0, glowY = 0;

      document.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
      });

      // Smooth animation for cursor glow
      function animateCursor() {
        glowX += (mouseX - glowX) * 0.1;
        glowY += (mouseY - glowY) * 0.1;

        if (cursorGlow) {
          cursorGlow.style.left = glowX + 'px';
          cursorGlow.style.top = glowY + 'px';
        }

        requestAnimationFrame(animateCursor);
      }
      animateCursor();

      // Hide cursor glow when mouse leaves window
      document.addEventListener('mouseleave', () => {
        if (cursorGlow) cursorGlow.style.opacity = '0';
      });
      document.addEventListener('mouseenter', () => {
        if (cursorGlow) cursorGlow.style.opacity = '1';
      });

      // Scroll reveal animation with Intersection Observer
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.15
      };

      const revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
            // Optional: unobserve after animation
            // revealObserver.unobserve(entry.target);
          }
        });
      }, observerOptions);

      // Observe all reveal elements
      document.querySelectorAll('.reveal, .reveal-left, .reveal-right, .reveal-scale, .stagger-children').forEach(el => {
        revealObserver.observe(el);
      });

      // Magnetic button effect
      document.querySelectorAll('.magnetic-btn').forEach(btn => {
        btn.addEventListener('mousemove', (e: Event) => {
          const mouseEvent = e as MouseEvent;
          const rect = btn.getBoundingClientRect();
          const x = mouseEvent.clientX - rect.left - rect.width / 2;
          const y = mouseEvent.clientY - rect.top - rect.height / 2;

          (btn as HTMLElement).style.transform = `translate(${x * 0.2}px, ${y * 0.2}px)`;
        });

        btn.addEventListener('mouseleave', () => {
          (btn as HTMLElement).style.transform = 'translate(0, 0)';
        });
      });
    </script>
  </body>
</html>
